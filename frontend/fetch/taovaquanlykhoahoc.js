import {fetchGiangVien, fetchKhoaHoc, fetchChiTietKhoaHoc,fetchDanhMuc,  fetchKhoaHocVoiId} from './get.js';
import {addKhoaHoc, addChiTietKhoaHoc, addChiTietNhanVien} from './add.js';
import {UpdateKhoaHoc, UpdateChiTietKhoaHoc} from './update.js';

document.getElementById('course-image').addEventListener('change', function(event) {
   
        HienThiAnh(event, null);

   
    
});

async function loadDanhMucToSelect(selectedId = null) {
  const data = await fetchDanhMuc(); // L·∫•y d·ªØ li·ªáu danh m·ª•c
  const select = document.getElementById("danhmuc");

  select.innerHTML = '';


    data.forEach(dm => {
    const option = document.createElement("option");
    option.value = dm.iddanhmuc.toString(); // ƒë·∫£m b·∫£o value l√† chu·ªói
    option.textContent = dm.tendanhmuc;
    select.appendChild(option);

    console.log(`ID: ${dm.iddanhmuc}, T√™n danh m·ª•c: ${dm.tendanhmuc}`);
    });

// Ki·ªÉm tra th·ª≠
// alert(selectedId)
const option = document.querySelector(`#danhmuc option[value="${selectedId}"]`);
if (!option) {
  console.log(`‚ùå Kh√¥ng t√¨m th·∫•y option t∆∞∆°ng ·ª©ng v·ªõi ID: ${selectedId}`);
} else {
  console.log(`‚úÖ ƒê√£ t√¨m th·∫•y option: ${option.textContent}`);
}

}


let resizedImageBlob = null; // L∆∞u blob ·∫£nh ƒë√£ resize ƒë·ªÉ upload

// H√†m resize ·∫£nh
function cropAndResizeImage(file, size = 300, callback) {
    const reader = new FileReader();

    reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');

            // T√≠nh v√πng crop (c·∫Øt gi·ªØa ·∫£nh)
            let sx = 0, sy = 0, sSize = 0;
            if (img.width > img.height) {
                sSize = img.height;
                sx = (img.width - img.height) / 2;
            } else {
                sSize = img.width;
                sy = (img.height - img.width) / 2;
            }

            // V·∫Ω v√†o canvas v√πng ƒë√£ c·∫Øt
            ctx.drawImage(img, sx, sy, sSize, sSize, 0, 0, size, size);

            // T·∫°o blob v√† URL preview
            canvas.toBlob(function (blob) {
                const previewUrl = URL.createObjectURL(blob);
                callback(blob, previewUrl);
            }, file.type || 'image/jpeg', 0.9);
        };

        img.src = e.target.result;
    };

    reader.readAsDataURL(file);
}



async function HienThiAnh(event, images = null) {
    const prev = document.getElementById('preview');

    if (images) {
        prev.src = `http://localhost/quanlytrungtam/backend/upload/${images}`;
        prev.style.display = 'block';
        return;
    }

    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        cropAndResizeImage(file, 400, function (blob, previewUrl) {
            resizedImageBlob = blob;
            prev.src = previewUrl;
            prev.style.display = 'block';
        });
    }
}




async function themmoikhoahoc(event) {
    event.preventDefault(); // ch·ªâ c·∫ßn g·ªçi 1 l·∫ßn

    try {
        const ten = document.getElementById('course-name').value;
        const soluongbuoi = document.getElementById('soluongbuoi').value;
        const thoigianhoc = document.getElementById('thoigianhoc').value;
        const lichhoc = document.getElementById('lichhoc').value;
        const mota = document.getElementById('motakhoahoc').value;
        const giatien = document.getElementById('giatien').value;
        const giamgia = document.getElementById('giamgia').value;
        const start = document.getElementById('start').value;
        const end = document.getElementById('end').value;
        const danhmuc = document.getElementById('danhmuc').value;
        const data = {
            tenkhoahoc: ten,
            thoigianhoc,
            soluongbuoi,
            lichhoc,
            diadiemhoc: "not found",
            mota,
            trangthai: 1,
            giatien,
            giamgia,
            ngaybatdau: start,
            ngayketthuc: end,
            danhmuc : danhmuc
        };
        // console.log(danhm)
        console.log(data);

        const formData = new FormData();
        let fileToUpload = null;

        // N·∫øu c√≥ ·∫£nh ƒë√£ crop
        if (typeof resizedImageBlob !== 'undefined' && resizedImageBlob) {
            formData.append('file', resizedImageBlob, 'avatar.jpg');
            fileToUpload = resizedImageBlob;
        } else {
            const originalFile = document.getElementById('course-image')?.files[0];
            if (originalFile) {
                formData.append('file', originalFile);
                fileToUpload = originalFile;
            }
        }

        if (fileToUpload) {
            formData.append('image', fileToUpload);
        }

        formData.append('data', JSON.stringify(data));
        for (let pair of formData.entries()) {
    console.log(`${pair[0]}:`, pair[1]);
}


        // G·ªçi API th√™m kh√≥a h·ªçc
        const kq = await addKhoaHoc(formData);
        const res = JSON.parse(kq);
        console.log("K·∫øt qu·∫£ th√™m kh√≥a h·ªçc:", kq);

        if (!res || !res.idkhoahoc) {
            throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c ID kh√≥a h·ªçc t·ª´ k·∫øt qu·∫£.");
        }

        const id = res.idkhoahoc;
        alert("ƒê√£ th√™m kh√≥a h·ªçc, ID: " + id);

        // X·ª≠ l√Ω chi ti·∫øt b√†i h·ªçc
        const lessons = document.querySelectorAll('#noidungkhoahoc .lesson-item');
        const data3 = [];
        let d = 0;

        lessons.forEach(lesson => {
            const title = lesson.querySelector('.lesson-title')?.textContent.trim();
            const link = lesson.querySelector('.lesson-link a')?.href;

            console.log(title + " adfasd " + link);

            if (title && link) {
                data3.push({
                    idkhoahoc: id,
                    idbaihoc: d,
                    tenbaihoc: title,
                    link: link
                });
                d++;
            }
        });

        if (data3.length === 0) {
            alert("Kh√¥ng c√≥ b√†i h·ªçc n√†o ƒë∆∞·ª£c nh·∫≠p.");
            return;
        }

        const ct = await addChiTietKhoaHoc(data3);
        if (ct) {
            alert("Th√™m chi ti·∫øt kh√≥a h·ªçc th√†nh c√¥ng!");
        } else {
            alert("Th√™m chi ti·∫øt kh√≥a h·ªçc th·∫•t b·∫°i.");
        }

    } catch (error) {
        console.error("L·ªói:", error);
        alert("L·ªói: " + error.message);
    }
}


document.getElementById('themkhoahoc').onclick = async (event) => {
    event.preventDefault(); // NgƒÉn reload n·∫øu l√† form
   
     const urlParams = new URLSearchParams(window.location.search);
     const idkhoahoc = urlParams.get('idkhoahoc');

    if (idkhoahoc) {
        // C√≥ id => C·∫≠p nh·∫≠t
       
        await saveChanges(event, idkhoahoc);
    } else {
        // Kh√¥ng c√≥ id => Th√™m m·ªõi
        await themmoikhoahoc(event);
    }
};



document.addEventListener('DOMContentLoaded', async function (event) {
       loadDanhMucToSelect();
     const pa = new URLSearchParams(window.location.search);
     const images = pa.get('images');
    if (images) {
        // alert(images);
        HienThiAnh(event, images);  // Ch·ªâ x·ª≠ l√Ω ·∫£nh t·ª´ server (folder upload)
    }
   
    
    
  
    const urlParams = new URLSearchParams(window.location.search);
    const idkhoahoc = urlParams.get('idkhoahoc');
    // alert(idkhoahoc);
    const kq = await fetchKhoaHocVoiId(idkhoahoc);

   
   if (idkhoahoc) {
    const chitietdanhsach = document.getElementById('chitiet');
    chitietdanhsach.innerHTML = `
        <!-- Danh s√°ch h·ªçc vi√™n -->
        <div class="student-list-section">
           
            <a href="danhsachhocvien.html?idkhoahoc=${idkhoahoc}">üìã Danh s√°ch h·ªçc vi√™n</a>
        </div>

        <!-- Danh s√°ch gi·∫£ng vi√™n -->
        <div class="instructor-list-section" style="margin-top: 30px;">
          
            <a href="phanconggiangday.html?idkhoahoc=${idkhoahoc}">üë®‚Äçüè´ Danh s√°ch gi·∫£ng vi√™n</a>
        </div>`;


            
           

            
        document.getElementById('themkhoahoc').textContent="L∆∞u ch·ªânh s·ª≠a";
        console.log(("adfasdfads " , kq));
       


        const ten = document.getElementById('course-name');
        const gv = document.getElementById('instructor');
        const soluongbuoi = document.getElementById('soluongbuoi');
        const thoigianhoc = document.getElementById('thoigianhoc');
        const lichhoc = document.getElementById('lichhoc');
        const mota = document.getElementById('motakhoahoc');
        const giatien= document.getElementById('giatien');
        const giamgia= document.getElementById('giamgia');
         const start= document.getElementById('start');
        const end= document.getElementById('end');
         const danhmuc= document.getElementById('danhmuc');
        
        // alert(kq[0]['tenkhoahoc']);
        ten.value = kq[0]['tenkhoahoc'];  // S·ª≠a t·ª´ textContent th√†nh value
        // gv.value = kq[0]['idnhanvien'];  // S·ª≠a t·ª´ textContent th√†nh value
        soluongbuoi.value = kq[0]['soluongbuoi'];  // S·ª≠a t·ª´ textContent th√†nh value
        thoigianhoc.value = kq[0]['thoigianhoc'];  // S·ª≠a t·ª´ textContent th√†nh value
        lichhoc.value = kq[0]['lichhoc'];  // S·ª≠a t·ª´ textContent th√†nh value
        mota.value=kq[0]['mota'];
        giatien.value=kq[0]['giatien'];
        giamgia.value=kq[0]['giamgia'];
        start.value=kq[0]['ngaybatdau'];
        console.log(start.value);
        end.value=kq[0]['ngayketthuc'];
        danhmuc.value = kq[0]['danhmuc'].toString();
        // alert(danhmuc.value);
        // loadDanhMucToSelect(danhmuc.value.toString());



        const chitiet = await fetchKhoaHocVoiId(idkhoahoc);
        console.log(chitiet);
        const noidung = document.getElementById('noidungkhoahoc');
        noidung.innerHTML="";
        chitiet.forEach(baihoc =>{
            noidung.innerHTML += `
            <div class="lesson-item">
              <span class="lesson-title">${baihoc.tenbaihoc}</span>
              <div class="lesson-actions">
                <button onclick="edit(this.closest('.lesson-item'), event)">‚úèÔ∏è</button>
                <button onclick="remove(this.closest('.lesson-item'), event)">üóëÔ∏è</button>
              </div>
              <div class="lesson-link">
                üëâ <a href="${baihoc.link}" target="_blank">${baihoc.link}</a>
              </div>
            </div>
          `;
          
        })

    }
   
    
});







async function add(){
    const noidungkhoahoc=document.getElementById('noidungkhoahoc');
    noidungkhoahoc.innerHTML += `
       <div class="lesson-item">
                            <span class="lesson-title">üìò B√†i 1: H·ªçc b·∫£ng ch·ªØ c√°i</span>
                            <div class="lesson-actions">
                                <button onclick="edit(this.closest('.lesson-item'), event)">‚úèÔ∏è</button>
                                <button onclick="remove(this.closest('.lesson-item'), event)">üóëÔ∏è</button>
                            </div>
                            <div class="lesson-link">
                                üëâ <a href="https://example.com/bai-1" target="_blank">M·ªü b√†i h·ªçc</a>
                            </div>
                        </div>
    `;
}


function save(lessonElement, event) {
    event.stopPropagation();
    lessonElement.classList.remove("editing");

    const newTitle = lessonElement.querySelector('#lesson-item-title').value;
    const newLink = lessonElement.querySelector('#lesson-item-link').value;

    lessonElement.querySelector('#lesson-item-title').outerHTML = `
        <span class="lesson-title" onclick="toggleLink(this.parentElement)">üìò ${newTitle}</span>
    `;

    lessonElement.querySelector('.lesson-link').innerHTML = `
        üëâ <a href="${newLink}" target="_blank">M·ªü b√†i h·ªçc</a>
    `;

    lessonElement.querySelector('.lesson-actions').innerHTML = `
        <button onclick="edit(this.closest('.lesson-item'), event)">‚úèÔ∏è</button>
        <button onclick="remove(this.closest('.lesson-item'), event)">üóëÔ∏è</button>
    `;
}

function edit(lessonElement, event) {
    event.stopPropagation();
    lessonElement.classList.add("editing", "expanded"); // m·ªü r·ªông khi edit

    const titleSpan = lessonElement.querySelector('.lesson-title');
    const oldTitle = titleSpan.textContent.replace("üìò ", "");

    const linkElement = lessonElement.querySelector('.lesson-link a');
    const oldLink = linkElement ? linkElement.href : '';

    titleSpan.outerHTML = `
        <input type="text" id="lesson-item-title" value="${oldTitle}" />
    `;

    lessonElement.querySelector('.lesson-link').innerHTML = `
        üëâ <input type="text" id="lesson-item-link" value="${oldLink}" />
    `;

    lessonElement.querySelector('.lesson-actions').innerHTML = `
        <button onclick="save(this.closest('.lesson-item'), event)">üíæ</button>
        <button onclick="remove(this.closest('.lesson-item'), event)">üóëÔ∏è</button>
    `;
}







function remove(button, event) {
    const lessonElement = button.closest('.lesson-item');
    lessonElement.remove();
    event.stopPropagation();
}



function toggleLink(titleElement) {
    const item = titleElement.closest('.lesson-item');

    // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô ch·ªânh s·ª≠a th√¨ kh√¥ng toggle
    if (item.classList.contains('editing')) return;

    // Accordion: ƒë√≥ng t·∫•t c·∫£ b√†i kh√°c
    document.querySelectorAll('.lesson-item').forEach(el => {
        if (el !== item) el.classList.remove('expanded');
    });

    // Toggle ch√≠nh item ƒë∆∞·ª£c click
    item.classList.toggle('expanded');
}

let trangthai=1;
document.querySelectorAll('.lesson-item').forEach(item => {
    item.addEventListener('click', function () {
        toggleLink(this);
    });
});

window.edit = edit;
window.remove = remove;
window.save = save;
window.add = add;

async function saveChanges(event, idkhoahoc) {
    event.preventDefault();

    const ten = document.getElementById('course-name').value;
    const soluongbuoi = document.getElementById('soluongbuoi').value;
    const thoigianhoc = document.getElementById('thoigianhoc').value;
    const lichhoc = document.getElementById('lichhoc').value;
    // const idnhanvien = document.getElementById('instructor').value;
    const mota = document.getElementById('motakhoahoc').value;
    const giatien = document.getElementById('giatien').value;
    const giamgia = document.getElementById('giamgia').value;
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
     const danhmuc = document.getElementById('danhmuc').value;

    const today = new Date().toISOString().split('T')[0]; // L·∫•y ng√†y h√¥m nay ·ªü ƒë·ªãnh d·∫°ng 'YYYY-MM-DD'
// alert(today);

if (end <= today) {
    // G·ªçi API c·∫≠p nh·∫≠t tr·∫°ng th√°i
    trangthai = 2
}
else {
    trangthai = 1
}
    const data = {
        idkhoahoc: idkhoahoc,
        tenkhoahoc: ten,
        soluongbuoi: soluongbuoi,
        thoigianhoc: thoigianhoc,
        lichhoc: lichhoc,
        mota: mota,
        giatien: giatien,
        giamgia: giamgia,
        ngaybatdau : start,
        ngayketthuc : end,
        trangthai : trangthai,
        danhmuc : danhmuc
        // idnhanvien: idnhanvien
    };
    console.log(data);
    try {
        
        if (await UpdateKhoaHoc(data)) {
            console.log(data);
            // alert("C·∫≠p nh·∫≠t kh√≥a h·ªçc th√†nh c√¥ng!");

            // X·ª≠ l√Ω chi ti·∫øt b√†i h·ªçc
            const lessons = document.querySelectorAll('#noidungkhoahoc .lesson-item');
            const data3 = [];
            let d=0;
            lessons.forEach(lesson =>{
                const title = lesson.querySelector('.lesson-title')?.textContent.trim();
                const link=lesson.querySelector('.lesson-link a')?.href;
                // alert(d);
                data3.push({
                    idkhoahoc : idkhoahoc,
                    idbaihoc: d,
                    tenbaihoc:title,
                    link: link
                });
                d++;
            });
            // alert("cho anh");
            console.log("data 3" , data3);
            if (await UpdateChiTietKhoaHoc(data3)){
                    // alert("cap nhat chi tiet thanh cong");
                    window.location.href="danhsachkhoahoc.html"
            }
            
            else {
                alert("cap nhat chi tiet that bai");
            }
        
        

        } else {
            alert("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + result.message);
        }

    } catch (error) {
        alert("L·ªói khi c·∫≠p nh·∫≠t kh√≥a h·ªçc: " + error.message);
    }
}